name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: todo-app
  GITOPS_REPO: Piyushbajpai11/todo-app-gitops

jobs:
  build-and-deploy:
    name: Build, Scan, Push & Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Generate build metadata
      id: meta
      run: |
        echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "VERSION=v1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT

    - name: Build Docker image
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.meta.outputs.SHORT_SHA }}
      run: |
        # Build image
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "IMAGE=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "âœ… Docker image built successfully"

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.build-image.outputs.IMAGE }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  # Don't fail the build, just report

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.meta.outputs.SHORT_SHA }}
        VERSION: ${{ steps.meta.outputs.VERSION }}
      run: |
        # Push with git SHA tag
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        # Push with version tag
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$VERSION
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$VERSION
        
        # Push latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Tag for dev environment
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:dev
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:dev
        
        echo "âœ… Image pushed to ECR with tags: $IMAGE_TAG, $VERSION, dev, latest"

    - name: Update GitOps repository (Dev)
      env:
        GITOPS_TOKEN: ${{ secrets.GITOPS_REPO_TOKEN }}
        IMAGE_TAG: ${{ steps.meta.outputs.SHORT_SHA }}
        VERSION: ${{ steps.meta.outputs.VERSION }}
      run: |
        # Clone GitOps repo
        git clone https://$GITOPS_TOKEN@github.com/$GITOPS_REPO.git gitops
        cd gitops
        
        # Update dev values with new image tag
        sed -i "s|tag: .*|tag: \"$IMAGE_TAG\"|g" helm-charts/todo-app/values-dev.yaml
        
        # Commit and push
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add helm-charts/todo-app/values-dev.yaml
        git commit -m "ðŸš€ Update dev image to $VERSION ($IMAGE_TAG)" || echo "No changes to commit"
        git push
        
        echo "âœ… GitOps repo updated - ArgoCD will auto-sync dev environment"

    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ steps.meta.outputs.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.meta.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** Dev (auto-deployed)" >> $GITHUB_STEP_SUMMARY
        echo "- **Image:** ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. âœ… Dev environment will auto-sync via ArgoCD" >> $GITHUB_STEP_SUMMARY
        echo "2. ðŸ”„ Promote to staging by updating \`values-staging.yaml\`" >> $GITHUB_STEP_SUMMARY
        echo "3. ðŸ”„ Promote to prod by updating \`values-prod.yaml\`" >> $GITHUB_STEP_SUMMARY